{{- range $serviceName, $service := .Values.services }}

apiVersion: apps/v1
kind: Deployment
metadata: 
  name: {{ $.Values.name }}-{{ $serviceName }}
  labels: 
    app: {{ $.Values.name }}-{{ $serviceName }}
spec: 
  replicas: 1
  strategy:
    type: Recreate
  selector: 
    matchLabels: 
      app: {{ $.Values.name }}-{{ $serviceName }}
  template: 
    metadata: 
      labels: 
        app: {{ $.Values.name }}-{{ $serviceName }}
      annotations: 
        dapr.io/enabled: 'true'
        dapr.io/app-id: '{{ $.Values.name }}-{{ $serviceName }}'
        dapr.io/app-port: '80'
        dapr.io/http-max-request-size: '128'
        dapr.io/log-level: 'info'
        {{ if $service.dapr  }} 
        dapr.io/config: '{{ $.Values.name }}-{{ $serviceName }}-dapr-config-{{ template "rand" . }}'
        {{ end }}
    spec:   
      {{ if $service.init  }}  
      initContainers: 
      - name: {{ $.Values.name }}-{{ $serviceName }}-init
        image: {{ $.Values.registry }}/{{ $.Values.name }}/{{ $serviceName }}
        {{ if $service.init.args }}
        args: 
        {{ range $service.init.args }}
          - {{ quote . }}
        {{ end }}
        {{ end }}
        ports: 
        - containerPort: 80
        volumeMounts: 
        - name: cacertificates
          mountPath: /etc/ssl/certs
          readOnly: true
        imagePullPolicy: IfNotPresent
        env:
        {{ if $service.configs }}
        {{ range $service.configs }}
        {{ if .env }}
        - name: {{ .env }}
          valueFrom: 
            configMapKeyRef: 
              name: {{ $.Values.name }}-{{ $serviceName }}-config-{{ template "rand" . }}
              key: {{ .name }}
        {{ end }}
        {{ end }}
        {{ end }}
        {{ if $service.secrets }}
        {{ range $service.secrets }}
        {{ if .env }}
        - name: {{ .env }}
          valueFrom: 
            secretKeyRef: 
              name: {{ $.Values.name }}-{{ $serviceName }}-secret-{{ template "rand" . }}
              key: {{ .name }}
        {{ end }}
        {{ end }}
        {{ end }}
        {{ if $service.mapEnvVars }}
        {{ if $service.mapEnvVars.identityServerUrl }}
        - name: {{ $service.mapEnvVars.identityServerUrl }} 
          valueFrom: 
            configMapKeyRef: 
              name: environment
              key: identity-server-url
        {{ end }}
        {{ if $service.mapEnvVars.environment }}
        - name: {{ $service.mapEnvVars.environment }}
          valueFrom: 
            configMapKeyRef: 
              name: environment
              key: name
        {{ end }}
        {{ end }}
      {{ end }}
      containers: 
      - name: {{ $.Values.name }}-{{ $serviceName }}
        image: {{ $.Values.registry }}/{{ $.Values.name }}/{{ $serviceName }}
        ports: 
        - containerPort: 80
        volumeMounts: 
        - name: cacertificates
          mountPath: /etc/ssl/certs
          readOnly: true
        imagePullPolicy: IfNotPresent
        env:
        {{ if $service.configs }}
        {{ range $service.configs }}
        {{ if .env }}
        - name: {{ .env }}
          valueFrom: 
            configMapKeyRef: 
              name: {{ $.Values.name }}-{{ $serviceName }}-config-{{ template "rand" . }}
              key: {{ .name }}
        {{ end }}
        {{ end }}
        {{ end }}
        {{ if $service.secrets }}
        {{ range $service.secrets }}
        {{ if .env }}
        - name: {{ .env }}
          valueFrom: 
            secretKeyRef: 
              name: {{ $.Values.name }}-{{ $serviceName }}-secret-{{ template "rand" . }}
              key: {{ .name }}
        {{ end }}
        {{ end }}
        {{ end }}
        {{ if $service.mapEnvVars }}
        {{ if $service.mapEnvVars.identityServerUrl }}
        - name: {{ $service.mapEnvVars.identityServerUrl }} 
          valueFrom: 
            configMapKeyRef: 
              name: environment
              key: identity-server-url
        {{ end }}
        {{ if $service.mapEnvVars.environment }}
        - name: {{ $service.mapEnvVars.environment }}
          valueFrom: 
            configMapKeyRef: 
              name: environment
              key: name
        {{ end }}
        {{ end }}
      volumes: 
      - name: cacertificates
        secret: 
          secretName: ca-certificates  
      {{ if $.Values.imagePullSecret }}
      imagePullSecrets:
      - name: {{ $.Values.imagePullSecret }}
      {{ end }}
---
{{ end }}
  
  
